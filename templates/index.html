<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trends Explorer â€” Google è¶¨å‹¢åˆ†æ</title>
  <meta name="description" content="å³æ™‚æŸ¥è©¢ Google æœå°‹è¶¨å‹¢ï¼Œæ¯”è¼ƒé—œéµå­—ç†±åº¦ã€åœ°å€åˆ†ä½ˆèˆ‡ç›¸é—œæŸ¥è©¢ã€‚" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

  <style>
    /* â”€â”€ Reset & Tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #080c14;
      --surface: #0f1622;
      --surface2: #161e30;
      --border: rgba(255, 255, 255, 0.07);
      --accent: #6366f1;
      --accent2: #22d3ee;
      --green: #10b981;
      --amber: #f59e0b;
      --rose: #f43f5e;
      --text: #e2e8f0;
      --muted: #64748b;
      --radius: 16px;
      --radius-sm: 10px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* â”€â”€ Background glow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 80% 50% at 20% -10%, rgba(99, 102, 241, 0.15) 0%, transparent 60%),
        radial-gradient(ellipse 60% 40% at 80% 110%, rgba(34, 211, 238, 0.1) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .container {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px 60px;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      padding: 40px 0 32px;
      text-align: center;
    }

    .logo-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(99, 102, 241, 0.12);
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 99px;
      padding: 6px 16px;
      font-size: 12px;
      font-weight: 600;
      color: #a5b4fc;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 20px;
    }

    .logo-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent2);
      box-shadow: 0 0 8px var(--accent2);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.5;
        transform: scale(0.8);
      }
    }

    h1 {
      font-size: clamp(2rem, 5vw, 3.2rem);
      font-weight: 800;
      line-height: 1.15;
      background: linear-gradient(135deg, #e2e8f0 0%, #a5b4fc 50%, #22d3ee 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
    }

    .subtitle {
      color: var(--muted);
      font-size: 1rem;
      font-weight: 400;
    }

    /* â”€â”€ Search Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .search-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px;
      margin-bottom: 28px;
      backdrop-filter: blur(20px);
    }

    .search-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
      min-width: 160px;
    }

    .field label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .field input,
    .field select {
      height: 46px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      padding: 0 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      width: 100%;
    }

    .field input:focus,
    .field select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .field select option {
      background: #1e293b;
    }

    .btn-search {
      height: 46px;
      padding: 0 28px;
      background: linear-gradient(135deg, var(--accent), #818cf8);
      border: none;
      border-radius: var(--radius-sm);
      color: #fff;
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-search:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
    }

    .btn-search:active {
      transform: translateY(0);
    }

    .btn-search:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* suggestions dropdown */
    .suggest-box {
      position: relative;
    }

    #suggest-list {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      z-index: 100;
      overflow: hidden;
      display: none;
    }

    #suggest-list.show {
      display: block;
    }

    .suggest-item {
      padding: 10px 14px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
      transition: background 0.15s;
    }

    .suggest-item:hover {
      background: rgba(99, 102, 241, 0.15);
    }

    .suggest-item .s-title {
      font-size: 13px;
      font-weight: 500;
    }

    .suggest-item .s-type {
      font-size: 11px;
      color: var(--muted);
    }

    /* â”€â”€ Status / Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-bar {
      text-align: center;
      padding: 12px;
      font-size: 13px;
      color: var(--muted);
      display: none;
    }

    .status-bar.show {
      display: block;
    }

    .status-bar.error {
      color: var(--rose);
    }

    /* â”€â”€ Loading spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* â”€â”€ Grid Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      transition: border-color 0.3s;
    }

    .card:hover {
      border-color: rgba(99, 102, 241, 0.3);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }

    /* â”€â”€ Chart containers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chart-wrap {
      position: relative;
      height: 260px;
    }

    /* â”€â”€ Region bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .region-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .region-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .region-name {
      width: 90px;
      font-size: 13px;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-shrink: 0;
    }

    .region-bar-wrap {
      flex: 1;
      height: 8px;
      background: var(--surface2);
      border-radius: 99px;
      overflow: hidden;
    }

    .region-bar {
      height: 100%;
      border-radius: 99px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .region-val {
      width: 32px;
      text-align: right;
      font-size: 12px;
      font-weight: 600;
      color: var(--accent2);
    }

    /* â”€â”€ Related Queries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .rq-tabs {
      display: flex;
      gap: 4px;
      background: var(--surface2);
      border-radius: var(--radius-sm);
      padding: 4px;
      margin-bottom: 16px;
    }

    .rq-tab {
      flex: 1;
      padding: 7px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      color: var(--muted);
      transition: background 0.2s, color 0.2s;
    }

    .rq-tab.active {
      background: var(--accent);
      color: #fff;
    }

    .rq-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .rq-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 9px 12px;
      background: var(--surface2);
      border-radius: var(--radius-sm);
      font-size: 13px;
      transition: background 0.2s;
    }

    .rq-item:hover {
      background: rgba(99, 102, 241, 0.12);
    }

    .rq-query {
      color: var(--text);
    }

    .rq-val {
      font-size: 11px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 99px;
    }

    .rq-val.top {
      background: rgba(99, 102, 241, 0.2);
      color: #a5b4fc;
    }

    .rq-val.rising {
      background: rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
    }

    /* â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .history-card {
      margin-top: 20px;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .history-table th {
      text-align: left;
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    .history-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      vertical-align: top;
    }

    .history-table tr:last-child td {
      border-bottom: none;
    }

    .history-table tr:hover td {
      background: rgba(99, 102, 241, 0.06);
    }

    .history-kw-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .history-kw {
      padding: 2px 8px;
      border-radius: 99px;
      background: rgba(99, 102, 241, 0.18);
      color: #a5b4fc;
      font-size: 11px;
      font-weight: 600;
    }

    .history-score {
      font-size: 11px;
      color: var(--muted);
    }

    .history-time {
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
    }

    /* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty {
      text-align: center;
      padding: 40px 0;
      color: var(--muted);
      font-size: 13px;
    }

    .empty svg {
      margin-bottom: 12px;
      opacity: 0.3;
    }

    /* â”€â”€ Keyword chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .kw-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 12px;
    }

    .kw-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 99px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    .kw-chip .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
    }

    /* â”€â”€ Discovery Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .discovery-panel {
      margin-top: 20px;
      background: var(--surface);
      border: 1px solid rgba(34, 211, 238, 0.2);
      border-radius: var(--radius);
      padding: 28px;
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
    }

    .discovery-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--accent2), var(--accent), transparent);
    }

    .discovery-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .discovery-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .discovery-title h3 {
      font-size: 15px;
      font-weight: 700;
      color: var(--text);
    }

    .discovery-badge {
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 99px;
      background: rgba(34, 211, 238, 0.15);
      color: var(--accent2);
      border: 1px solid rgba(34, 211, 238, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .discovery-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .discovery-controls .field {
      min-width: 130px;
    }

    .btn-discover {
      height: 46px;
      padding: 0 22px;
      background: linear-gradient(135deg, var(--accent2), #0891b2);
      border: none;
      border-radius: var(--radius-sm);
      color: #082f49;
      font-family: inherit;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-discover:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(34, 211, 238, 0.35);
    }

    .btn-discover:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-refresh {
      height: 46px;
      padding: 0 16px;
      background: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--muted);
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: border-color 0.2s, color 0.2s;
    }

    .btn-refresh:hover {
      border-color: var(--accent2);
      color: var(--accent2);
    }

    .discovery-results {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .discovery-results {
        grid-template-columns: 1fr;
      }
    }

    .discovery-col-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Top keywords score bars */
    .top-kw-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .top-kw-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .top-kw-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-kw-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .top-kw-score {
      font-size: 11px;
      font-weight: 700;
      color: var(--accent2);
    }

    .top-kw-bar-wrap {
      height: 6px;
      background: var(--surface2);
      border-radius: 99px;
      overflow: hidden;
    }

    .top-kw-bar {
      height: 100%;
      border-radius: 99px;
      background: linear-gradient(90deg, var(--accent2), var(--accent));
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Related keywords */
    .related-kw-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .related-kw-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 10px;
      background: var(--surface2);
      border-radius: var(--radius-sm);
      font-size: 13px;
      gap: 8px;
      transition: background 0.2s;
    }

    .related-kw-item:hover {
      background: rgba(34, 211, 238, 0.08);
    }

    .related-kw-name {
      color: var(--text);
      flex: 1;
    }

    .related-kw-source {
      font-size: 10px;
      color: var(--muted);
      flex-shrink: 0;
    }

    .related-kw-tag {
      font-size: 10px;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 99px;
      flex-shrink: 0;
    }

    .related-kw-tag.top {
      background: rgba(99, 102, 241, 0.2);
      color: #a5b4fc;
    }

    .related-kw-tag.rising {
      background: rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
    }

    /* æœå‹™/å•†å“æ¨™ç±¤ */
    .service-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 5px;
    }

    .service-tag {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 99px;
      background: rgba(251, 191, 36, 0.15);
      color: #fcd34d;
      border: 1px solid rgba(251, 191, 36, 0.25);
      white-space: nowrap;
    }

    .service-tag.primary {
      background: rgba(251, 146, 60, 0.2);
      color: #fb923c;
      border-color: rgba(251, 146, 60, 0.35);
      font-weight: 700;
    }

    .top-kw-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .discovery-cache-info {
      font-size: 11px;
      color: var(--muted);
      margin-top: 14px;
      text-align: right;
    }

    .discovery-cache-info .cache-hit {
      color: var(--green);
    }
  </style>
</head>

<body>

  <div class="container">

    <!-- Header -->
    <header>
      <div class="logo-badge">å³æ™‚è¶¨å‹¢åˆ†æ</div>
      <h1>Google Trends Explorer</h1>
      <p class="subtitle">è¼¸å…¥é—œéµå­—ï¼Œå³æ™‚æ¢ç´¢æœå°‹è¶¨å‹¢ã€åœ°å€åˆ†ä½ˆèˆ‡ç›¸é—œæŸ¥è©¢</p>
    </header>

    <!-- Search Panel -->
    <div class="search-panel">
      <div class="search-row">

        <!-- Keyword input with suggestions -->
        <div class="field suggest-box" style="flex:2; min-width:240px;">
          <label>é—œéµå­—ï¼ˆæœ€å¤š 5 å€‹ï¼Œç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
          <input type="text" id="kw-input" placeholder="ä¾‹ï¼šChatGPT, Gemini, Claude" autocomplete="off" />
          <div id="suggest-list"></div>
        </div>

        <!-- Region -->
        <div class="field">
          <label>åœ°å€</label>
          <select id="geo-select">
            <option value="TW">ğŸ‡¹ğŸ‡¼ å°ç£</option>
            <option value="US">ğŸ‡ºğŸ‡¸ ç¾åœ‹</option>
            <option value="JP">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
            <option value="KR">ğŸ‡°ğŸ‡· éŸ“åœ‹</option>
            <option value="GB">ğŸ‡¬ğŸ‡§ è‹±åœ‹</option>
            <option value="">ğŸŒ å…¨çƒ</option>
          </select>
        </div>

        <!-- Timeframe -->
        <div class="field">
          <label>æ™‚é–“ç¯„åœ</label>
          <select id="time-select">
            <option value="now 7-d">éå» 7 å¤©</option>
            <option value="today 1-m">éå» 1 å€‹æœˆ</option>
            <option value="today 3-m" selected>éå» 3 å€‹æœˆ</option>
            <option value="today 12-m">éå» 12 å€‹æœˆ</option>
            <option value="today 5-y">éå» 5 å¹´</option>
          </select>
        </div>

        <!-- Submit -->
        <div class="field" style="flex:0 0 auto;">
          <label style="visibility:hidden;">æœå°‹</label>
          <button class="btn-search" id="search-btn" onclick="search()">
            <span id="btn-icon">ğŸ”</span>
            <span id="btn-text">æŸ¥è©¢è¶¨å‹¢</span>
          </button>
        </div>
      </div>

      <!-- Keyword chips -->
      <div class="kw-chips" id="kw-chips"></div>

      <!-- Status -->
      <div class="status-bar" id="status-bar"></div>
    </div>

    <!-- Charts Grid -->
    <div class="grid-2">

      <!-- Interest Over Time -->
      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-header">
          <div class="card-title"><span class="dot"></span>æœå°‹ç†±åº¦è¶¨å‹¢</div>
        </div>
        <div class="chart-wrap">
          <canvas id="iot-chart"></canvas>
          <div class="empty" id="iot-empty" style="display:none;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M3 3v18h18" />
              <path d="m19 9-5 5-4-4-3 3" />
            </svg>
            <div>æŸ¥è©¢å¾Œï¼Œè¶¨å‹¢åœ–è¡¨å°‡é¡¯ç¤ºæ–¼æ­¤</div>
          </div>
        </div>
        <!-- AI è¶¨å‹¢æ´å¯Ÿ -->
        <div id="ai-insight-wrap" style="display:none;margin-top:16px;">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
            <span style="font-size:14px;font-weight:600;color:var(--text-secondary);">âœ¨ AI è¶¨å‹¢æ´å¯Ÿ</span>
            <span id="ai-insight-badge"
              style="font-size:10px;padding:2px 8px;border-radius:99px;background:rgba(139,92,246,0.2);color:#c4b5fd;">Qwen2.5</span>
          </div>
          <div id="ai-insight-text"
            style="font-size:13px;line-height:1.8;color:var(--text-secondary);padding:12px 16px;background:rgba(139,92,246,0.07);border-radius:12px;border-left:3px solid rgba(139,92,246,0.4);">
            è¼‰å…¥ä¸­â€¦</div>
        </div>
      </div>

      <!-- Interest by Region -->
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span class="dot"
              style="background:var(--accent2);box-shadow:0 0 8px var(--accent2)"></span>åœ°å€åˆ†ä½ˆ</div>
        </div>
        <div id="region-content">
          <div class="empty">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10" />
              <path
                d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
            </svg>
            <div>æŸ¥è©¢å¾Œï¼Œåœ°å€åˆ†ä½ˆå°‡é¡¯ç¤ºæ–¼æ­¤</div>
          </div>
        </div>
      </div>

      <!-- Related Queries -->
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span class="dot"
              style="background:var(--green);box-shadow:0 0 8px var(--green)"></span>ç›¸é—œæŸ¥è©¢</div>
        </div>
        <div id="rq-content">
          <div class="empty">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
            </svg>
            <div>æŸ¥è©¢å¾Œï¼Œç›¸é—œæœå°‹è©å°‡é¡¯ç¤ºæ–¼æ­¤</div>
          </div>
        </div>
      </div>

    </div>

    <!-- History Panel -->
    <div class="card history-card">
      <div class="card-header">
        <div class="card-title"><span class="dot" style="background:#f59e0b;box-shadow:0 0 8px #f59e0b"></span>æŸ¥è©¢æ­·å²è¨˜éŒ„
        </div>
        <button onclick="loadHistory()"
          style="background:none;border:1px solid var(--border);border-radius:8px;padding:5px 12px;color:var(--muted);font-size:12px;cursor:pointer;">é‡æ–°æ•´ç†</button>
      </div>
      <div id="history-content">
        <div class="empty">è¼‰å…¥ä¸­â€¦</div>
      </div>
    </div>

    <!-- â”€â”€ Keyword Discovery Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="discovery-panel">

      <div class="discovery-header">
        <div class="discovery-title">
          <span style="font-size:20px">ğŸ¯</span>
          <h3>é«˜è²é‡é—œéµå­—ç™¼ç¾</h3>
          <span class="discovery-badge">æ¯é€±å‹•æ…‹æ›´æ–°</span>
        </div>
        <!-- èªæ„æœå°‹ -->
        <div style="display:flex;gap:8px;align-items:center;margin-top:10px;">
          <input type="text" id="semantic-query" placeholder="ğŸ”¬ èªæ„æœå°‹é—œéµå­—ï¼ˆä¾‹ï¼šç‰™é½’çŸ¯æ­£è²»ç”¨ï¼‰"
            style="flex:1;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:13px;"
            onkeydown="if(event.key==='Enter')semanticSearch()" />
          <button onclick="semanticSearch()"
            style="padding:8px 14px;border-radius:8px;border:none;background:rgba(139,92,246,0.25);color:#c4b5fd;cursor:pointer;font-size:12px;white-space:nowrap;">ğŸ”¬
            èªæ„æœå°‹</button>
        </div>
        <div id="semantic-results" style="display:none;margin-top:8px;"></div>
      </div>

      <!-- Controls -->
      <div class="discovery-controls">
        <div class="field">
          <label>æ‡‰ç”¨å ´æ™¯</label>
          <select id="disc-scenario">
            <option value="æ—…éŠ">âœˆï¸ æ—…éŠ</option>
            <option value="å¥åº·">ğŸ’ª å¥åº·</option>
            <option value="ç‰™ç§‘">ğŸ¦· ç‰™ç§‘</option>
            <option value="ä¿å¥å“">ğŸ’Š ä¿å¥å“</option>
          </select>
        </div>
        <div class="field">
          <label>åœ°å€</label>
          <select id="disc-geo">
            <option value="TW">ğŸ‡¹ğŸ‡¼ å°ç£</option>
            <option value="US">ğŸ‡ºğŸ‡¸ ç¾åœ‹</option>
            <option value="JP">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
            <option value="">ğŸŒ å…¨çƒ</option>
          </select>
        </div>
        <div class="field" style="min-width:100px;max-width:140px;">
          <label>é«˜è²é‡å–å‰ <span id="topn-label">5</span> å€‹</label>
          <input type="range" id="disc-topn" min="1" max="5" value="5"
            style="height:46px;padding:10px 4px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);width:100%;accent-color:var(--accent2);"
            oninput="document.getElementById('topn-label').textContent=this.value">
        </div>
        <div class="field" style="flex:0 0 auto;">
          <label style="visibility:hidden;">ç™¼ç¾</label>
          <button class="btn-discover" id="disc-btn" onclick="discoverKeywords(false)">
            <span id="disc-btn-icon">ğŸ”</span>
            <span id="disc-btn-text">ç™¼ç¾é—œéµå­—</span>
          </button>
        </div>
        <div class="field" style="flex:0 0 auto;">
          <label style="visibility:hidden;">é‡å–</label>
          <button class="btn-refresh" id="disc-refresh-btn" onclick="discoverKeywords(true)"
            title="å¿½ç•¥å¿«å–ï¼Œå¼·åˆ¶é‡æ–°å¾ Google Trends æŠ“å–">
            ğŸ”„ å¼·åˆ¶é‡æ–°æ•´ç†
          </button>
        </div>
      </div>

      <!-- Status -->
      <div class="status-bar" id="disc-status"></div>

      <!-- Results -->
      <div class="discovery-results" id="disc-results" style="display:none;">
        <!-- Col 1: Top Keywords -->
        <div>
          <div class="discovery-col-title">
            <span style="color:var(--accent2)">ğŸ“Š</span> é«˜è²é‡é—œéµå­—
          </div>
          <div class="top-kw-list" id="disc-top-kws"></div>
        </div>
        <!-- Col 2: Related Keywords -->
        <div>
          <div class="discovery-col-title">
            <span style="color:var(--green)">ğŸ”—</span>
            ç›¸é—œæ“´å±•é—œéµå­—
            <span id="disc-related-count" style="font-weight:400;color:var(--muted)"></span>
          </div>
          <div class="related-kw-list" id="disc-related-kws"></div>
        </div>
      </div>

      <div class="discovery-cache-info" id="disc-cache-info" style="display:none;"></div>
    </div>

  </div>

  <script>
    // â”€â”€ Chart instance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let iotChart = null;

    const COLORS = ["#6366f1", "#22d3ee", "#f59e0b", "#10b981", "#f43f5e"];

    // â”€â”€ Suggestion debounce â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let suggestTimer = null;
    const kwInput = document.getElementById('kw-input');
    const suggestList = document.getElementById('suggest-list');

    kwInput.addEventListener('input', () => {
      clearTimeout(suggestTimer);
      const val = kwInput.value.split(',').pop().trim();
      if (val.length < 2) { hideSuggestions(); return; }
      suggestTimer = setTimeout(() => fetchSuggestions(val), 400);
    });

    kwInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') { hideSuggestions(); search(); }
      if (e.key === 'Escape') hideSuggestions();
    });

    document.addEventListener('click', e => {
      if (!e.target.closest('.suggest-box')) hideSuggestions();
    });

    async function fetchSuggestions(kw) {
      try {
        const res = await fetch(`/api/suggestions?kw=${encodeURIComponent(kw)}`);
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) { hideSuggestions(); return; }
        suggestList.innerHTML = data.map(s =>
          `<div class="suggest-item" onclick="applySuggestion('${s.title.replace(/'/g, "\\'")}')">
         <span class="s-title">${s.title}</span>
         <span class="s-type">${s.type}</span>
       </div>`
        ).join('');
        suggestList.classList.add('show');
      } catch { hideSuggestions(); }
    }

    function applySuggestion(title) {
      const parts = kwInput.value.split(',');
      parts[parts.length - 1] = ' ' + title;
      kwInput.value = parts.join(',').replace(/^\s,/, '').trim();
      hideSuggestions();
    }

    function hideSuggestions() {
      suggestList.classList.remove('show');
    }

    // â”€â”€ Main Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function search() {
      const kw = kwInput.value.trim();
      if (!kw) { setStatus('è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹é—œéµå­—', 'error'); return; }

      const geo = document.getElementById('geo-select').value;
      const timeframe = document.getElementById('time-select').value;
      const kwList = kw.split(',').map(k => k.trim()).filter(Boolean).slice(0, 5);

      setLoading(true);
      setStatus('æ­£åœ¨å‘ Google Trends æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™â€¦');
      renderChips(kwList);
      clearCharts();

      try {
        const params = new URLSearchParams({ kw: kwList.join(','), geo, timeframe });
        const [iotRes, regionRes, rqRes] = await Promise.all([
          fetch(`/api/interest-over-time?${params}`),
          fetch(`/api/interest-by-region?${params}`),
          fetch(`/api/related-queries?${params}`)
        ]);

        const [iotData, regionData, rqData] = await Promise.all([
          iotRes.json(), regionRes.json(), rqRes.json()
        ]);

        if (iotData.error) throw new Error(iotData.error);

        renderIOT(iotData);
        renderRegion(regionData);
        renderRelatedQueries(rqData, kwList[0]);
        setStatus('');
      } catch (e) {
        setStatus('âš ï¸ æŸ¥è©¢å¤±æ•—ï¼š' + e.message, 'error');
      } finally {
        setLoading(false);
      }
    }

    // â”€â”€ Render: Interest Over Time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderIOT({ labels, datasets }) {
      const canvas = document.getElementById('iot-chart');
      const empty = document.getElementById('iot-empty');

      if (!labels || labels.length === 0) {
        canvas.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      canvas.style.display = 'block';
      empty.style.display = 'none';

      if (iotChart) iotChart.destroy();

      iotChart = new Chart(canvas, {
        type: 'line',
        data: {
          labels,
          datasets: datasets.map((ds, i) => ({
            label: ds.label,
            data: ds.data,
            borderColor: COLORS[i],
            backgroundColor: COLORS[i] + '18',
            borderWidth: 2.5,
            pointRadius: 0,
            pointHoverRadius: 5,
            tension: 0.4,
            fill: true,
          }))
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: {
              labels: {
                color: '#94a3b8',
                boxWidth: 12,
                boxHeight: 12,
                borderRadius: 6,
                font: { size: 12, family: 'Inter' }
              }
            },
            tooltip: {
              backgroundColor: '#0f1622',
              borderColor: 'rgba(255,255,255,0.08)',
              borderWidth: 1,
              titleColor: '#e2e8f0',
              bodyColor: '#94a3b8',
              padding: 12,
              cornerRadius: 10,
            }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.04)' },
              ticks: {
                color: '#475569',
                font: { size: 11, family: 'Inter' },
                maxTicksLimit: 10,
              }
            },
            y: {
              min: 0, max: 100,
              grid: { color: 'rgba(255,255,255,0.04)' },
              ticks: {
                color: '#475569',
                font: { size: 11, family: 'Inter' },
              }
            }
          }
        }
      });
    }

    // â”€â”€ Render: Region â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderRegion({ regions, error }) {
      const el = document.getElementById('region-content');
      if (error || !regions || regions.length === 0) {
        el.innerHTML = `<div class="empty"><div>ç„¡åœ°å€è³‡æ–™</div></div>`;
        return;
      }
      const max = regions[0]?.value || 1;
      el.innerHTML = `<div class="region-list">` + regions.map(r => `
    <div class="region-item">
      <span class="region-name" title="${r.name}">${r.name}</span>
      <div class="region-bar-wrap">
        <div class="region-bar" style="width:${(r.value / max * 100).toFixed(1)}%"></div>
      </div>
      <span class="region-val">${r.value}</span>
    </div>
  `).join('') + `</div>`;
    }

    // â”€â”€ Render: Related Queries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderRelatedQueries(data, firstKw) {
      const el = document.getElementById('rq-content');
      const kd = data[firstKw];
      if (!kd) { el.innerHTML = `<div class="empty"><div>ç„¡ç›¸é—œæŸ¥è©¢è³‡æ–™</div></div>`; return; }

      const top = kd.top || [];
      const rising = kd.rising || [];

      el.innerHTML = `
    <div class="rq-tabs">
      <div class="rq-tab active" id="tab-top" onclick="switchTab('top')">ğŸ”¥ æœ€ç†±é–€</div>
      <div class="rq-tab" id="tab-rising" onclick="switchTab('rising')">ğŸ“ˆ ä¸Šå‡ä¸­</div>
    </div>
    <div id="rq-top" class="rq-list">
      ${top.length ? top.map(q =>
        `<div class="rq-item">
          <span class="rq-query">${q.query}</span>
          <span class="rq-val top">${q.value}</span>
        </div>`).join('') : '<div class="empty" style="padding:20px 0">ç„¡è³‡æ–™</div>'}
    </div>
    <div id="rq-rising" class="rq-list" style="display:none">
      ${rising.length ? rising.map(q =>
          `<div class="rq-item">
          <span class="rq-query">${q.query}</span>
          <span class="rq-val rising">${q.value === 2147483647 ? 'çˆ†ç‚¸æ€§ä¸Šå‡' : '+' + q.value + '%'}</span>
        </div>`).join('') : '<div class="empty" style="padding:24px 0;text-align:center"><div style="font-size:1.6rem;margin-bottom:8px">ğŸ“Š</div><div style="color:var(--text-secondary);font-size:0.85rem">æ­¤æ™‚æ®µç„¡æ˜é¡¯ä¸Šå‡è¶¨å‹¢<br>å¯å˜—è©¦æ›ä¸åŒé—œéµå­—æˆ–æ™‚é–“ç¯„åœ</div></div>'}
    </div>
  `;
    }


    function switchTab(tab) {
      document.getElementById('rq-top').style.display = tab === 'top' ? 'flex' : 'none';
      document.getElementById('rq-rising').style.display = tab === 'rising' ? 'flex' : 'none';
      document.getElementById('tab-top').classList.toggle('active', tab === 'top');
      document.getElementById('tab-rising').classList.toggle('active', tab === 'rising');
      document.getElementById('rq-top').style.flexDirection = 'column';
      document.getElementById('rq-rising').style.flexDirection = 'column';
    }

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderChips(kwList) {
      const container = document.getElementById('kw-chips');
      container.innerHTML = kwList.map((kw, i) => `
    <div class="kw-chip" style="background:${COLORS[i]}22; color:${COLORS[i]}; border:1px solid ${COLORS[i]}44;">
      <span class="chip-dot" style="background:${COLORS[i]}"></span>${kw}
    </div>
  `).join('');
    }

    function clearCharts() {
      if (iotChart) { iotChart.destroy(); iotChart = null; }
      document.getElementById('iot-chart').style.display = 'none';
      document.getElementById('iot-empty').style.display = 'none';
      document.getElementById('region-content').innerHTML =
        `<div class="empty"><div>è¼‰å…¥ä¸­â€¦</div></div>`;
      document.getElementById('rq-content').innerHTML =
        `<div class="empty"><div>è¼‰å…¥ä¸­â€¦</div></div>`;
    }

    function setStatus(msg, type = '') {
      const bar = document.getElementById('status-bar');
      bar.textContent = msg;
      bar.className = 'status-bar' + (msg ? ' show' : '') + (type ? ' ' + type : '');
    }

    function setLoading(on) {
      const btn = document.getElementById('search-btn');
      const icon = document.getElementById('btn-icon');
      const txt = document.getElementById('btn-text');
      btn.disabled = on;
      if (on) {
        icon.outerHTML = `<span class="spinner" id="btn-icon"></span>`;
        txt.textContent = 'æŸ¥è©¢ä¸­â€¦';
      } else {
        document.getElementById('btn-icon').outerHTML = `<span id="btn-icon">ğŸ”</span>`;
        txt.textContent = 'æŸ¥è©¢è¶¨å‹¢';
      }
    }

    // â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadHistory() {
      const el = document.getElementById('history-content');
      try {
        const res = await fetch('/api/history');
        const rows = await res.json();
        if (!Array.isArray(rows) || rows.length === 0) {
          el.innerHTML = `<div class="empty"><div>å°šç„¡æŸ¥è©¢è¨˜éŒ„</div></div>`;
          return;
        }
        el.innerHTML = `
      <table class="history-table">
        <thead>
          <tr>
            <th>é—œéµå­—</th>
            <th>åœ°å€</th>
            <th>æ™‚é–“ç¯„åœ</th>
            <th>å¹³å‡ç†±åº¦</th>
            <th>æŸ¥è©¢æ™‚é–“</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => {
          const kws = Array.isArray(r.keywords) ? r.keywords : [];
          const summary = r.result_summary || {};
          const scores = Object.entries(summary)
            .map(([k, v]) => `${k}: <b>${v}</b>`).join(' / ');
          const dt = new Date(r.queried_at);
          const timeStr = dt.toLocaleString('zh-TW', {
            month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });
          return `<tr>
              <td><div class="history-kw-list">${kws.map(k => `<span class="history-kw">${k}</span>`).join('')}</div></td>
              <td>${r.geo || 'å…¨çƒ'}</td>
              <td>${r.timeframe || '-'}</td>
              <td class="history-score">${scores || '-'}</td>
              <td class="history-time">${timeStr}</td>
            </tr>`;
        }).join('')}
        </tbody>
      </table>
    `;
      } catch (e) {
        el.innerHTML = `<div class="empty" style="color:var(--rose)">è¼‰å…¥å¤±æ•—ï¼š${e.message}</div>`;
      }
    }

    // â”€â”€ Auto-search on load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.addEventListener('DOMContentLoaded', () => {
      kwInput.value = 'ChatGPT, Gemini, Claude';
      loadHistory();
      setTimeout(search, 300);
    });

    // æ¯æ¬¡ search å®Œæˆå¾Œåˆ·æ–°æ­·å²
    const _origSearch = search;
    search = async function () {
      await _origSearch();
      setTimeout(loadHistory, 800);
    };

    // â”€â”€ Keyword Discovery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function discoverKeywords(forceRefresh = false) {
      const scenario = document.getElementById('disc-scenario').value;
      const geo = document.getElementById('disc-geo').value;
      const topN = document.getElementById('disc-topn').value;

      setDiscLoading(true);
      setDiscStatus(
        forceRefresh
          ? 'ğŸ”„ é‡æ–°å¾ Google Trends æŠ“å–ä¸­ï¼Œè«‹ç¨å€™ï¼ˆç´„éœ€ 20-60 ç§’ï¼‰â€¦'
          : 'ğŸ” æŸ¥è©¢ä¸­ï¼Œè‹¥æœ‰å¿«å–å°‡ç«‹å³è¿”å›â€¦'
      );

      document.getElementById('disc-results').style.display = 'none';
      document.getElementById('disc-cache-info').style.display = 'none';

      try {
        const params = new URLSearchParams({
          scenario,
          geo,
          top_n: topN,
          force_refresh: forceRefresh ? 'true' : 'false',
        });
        const res = await fetch(`/api/keyword-discovery?${params}`);
        const data = await res.json();

        if (data.error) throw new Error(data.error);

        renderDiscovery(data);
        setDiscStatus('');
      } catch (e) {
        setDiscStatus('âš ï¸ ç™¼ç¾å¤±æ•—ï¼š' + e.message, 'error');
      } finally {
        setDiscLoading(false);
      }
    }

    function renderDiscovery(data) {
      const topKws = data.top_keywords || [];
      const related = data.related_kws || [];

      // æœå‹™æ¨™ç±¤ helper
      function serviceTagsHTML(services) {
        if (!services || services.length === 0) return '';
        const tags = services.map((s, i) =>
          `<span class="service-tag${i === 0 ? ' primary' : ''}">ğŸ› ${s}</span>`
        ).join('');
        return `<div class="service-tags">${tags}</div>`;
      }

      // Top Keywords â€” score bars + service tags + æ·±åº¦åˆ†ææŒ‰éˆ•
      const maxScore = topKws.reduce((m, k) => Math.max(m, k.avg_score), 1);
      const scenario = document.getElementById('disc-scenario')?.value || '';
      document.getElementById('disc-top-kws').innerHTML = topKws.map((k, idx) => {
        const pct = Math.round((k.avg_score / maxScore) * 100);
        const safeId = `kw-${idx}`;
        return `
          <div class="top-kw-item">
            <div class="top-kw-label">
              <span class="top-kw-name">${k.keyword}</span>
              <span class="top-kw-score">${k.avg_score}</span>
              <button onclick="toggleDeepAnalysis('${safeId}','${k.keyword.replace(/'/g, "\\'")}','${scenario}')"
                style="margin-left:auto;padding:2px 10px;border-radius:99px;border:1px solid rgba(139,92,246,0.35);background:rgba(139,92,246,0.1);color:#c4b5fd;font-size:10px;cursor:pointer;">
                ğŸ” æ·±åº¦åˆ†æ
              </button>
            </div>
            <div class="top-kw-bar-wrap">
              <div class="top-kw-bar" style="width:0%" data-pct="${pct}"></div>
            </div>
            ${serviceTagsHTML(k.services)}
            <!-- æ·±åº¦åˆ†æå±•é–‹é¢æ¿ -->
            <div id="deep-${safeId}" style="display:none;margin-top:10px;border-top:1px solid rgba(255,255,255,0.08);padding-top:10px;"></div>
          </div>`;
      }).join('');

      // Animate bars after DOM paint
      requestAnimationFrame(() => {
        document.querySelectorAll('.top-kw-bar').forEach(bar => {
          bar.style.width = bar.dataset.pct + '%';
        });
      });

      // Related Keywords + service tags
      const showRelated = related.slice(0, 20);
      document.getElementById('disc-related-kws').innerHTML = showRelated.map(r => `
        <div class="related-kw-item" style="flex-direction:column;align-items:flex-start;gap:4px;">
          <div style="display:flex;align-items:center;gap:6px;width:100%;">
            <span class="related-kw-name">${r.keyword}</span>
            <span class="related-kw-source">â† ${r.source}</span>
            <span class="related-kw-tag ${r.type}">${r.type === 'rising' ? 'ğŸ“ˆ ä¸Šå‡' : 'ğŸ”¥ ç†±é–€'}</span>
          </div>
          ${serviceTagsHTML(r.services)}
        </div>
      `).join('');

      document.getElementById('disc-related-count').textContent =
        `ï¼ˆå…± ${related.length} ç­†ï¼‰`;

      // Cache info
      const cacheEl = document.getElementById('disc-cache-info');
      const dt = new Date(data.cached_at);
      const timeStr = dt.toLocaleString('zh-TW', {
        month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
      cacheEl.innerHTML = data.from_cache
        ? `<span class="cache-hit">âœ… ä½¿ç”¨å¿«å–</span>ï¼ˆå»ºç«‹æ™‚é–“ï¼š${timeStr}ï¼Œæœ‰æ•ˆæœŸ 7 å¤©ï¼‰`
        : `âœ¨ å³æ™‚æŠ“å–å®Œæˆï¼Œå·²å¿«å–è‡³ ${timeStr}`;
      cacheEl.style.display = 'block';

      document.getElementById('disc-results').style.display = 'grid';
    }

    function setDiscStatus(msg, type = '') {
      const bar = document.getElementById('disc-status');
      bar.textContent = msg;
      bar.className = 'status-bar' + (msg ? ' show' : '') + (type ? ' ' + type : '');
    }

    function setDiscLoading(on) {
      const btn = document.getElementById('disc-btn');
      const icon = document.getElementById('disc-btn-icon');
      const txt = document.getElementById('disc-btn-text');
      const refreshBtn = document.getElementById('disc-refresh-btn');
      btn.disabled = on;
      refreshBtn.disabled = on;
      if (on) {
        icon.textContent = '';
        icon.innerHTML = '<span class="spinner"></span>';
        txt.textContent = 'ç™¼ç¾ä¸­â€¦';
      } else {
        icon.innerHTML = 'ğŸ”';
        txt.textContent = 'ç™¼ç¾é—œéµå­—';
      }
    }

    // â”€â”€ HF AI Feature 1: è¶¨å‹¢æ´å¯Ÿæ‘˜è¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadAiInsight(keywords, iotData, geo) {
      const wrap = document.getElementById('ai-insight-wrap');
      const txt = document.getElementById('ai-insight-text');
      wrap.style.display = 'block';
      txt.textContent = 'âœ¨ AI æ­£åœ¨åˆ†æè¶¨å‹¢æ´å¯Ÿï¼Œè«‹ç¨å€™â€¦';
      try {
        const res = await fetch('/api/trend-summary', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keywords, data: iotData, geo }),
        });
        const data = await res.json();
        txt.textContent = data.summary || 'ï¼ˆç„¡æ³•ç”Ÿæˆæ´å¯Ÿï¼‰';
      } catch (e) {
        txt.textContent = 'âš ï¸ AI æ´å¯Ÿæš«æ™‚ç„¡æ³•ä½¿ç”¨';
      }
    }

    // â”€â”€ HF AI Feature 2: èªæ„æœå°‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function semanticSearch() {
      const query = document.getElementById('semantic-query').value.trim();
      if (!query) return;
      const scenario = document.getElementById('disc-scenario')?.value || '';
      const resultsEl = document.getElementById('semantic-results');
      resultsEl.style.display = 'block';
      resultsEl.innerHTML = '<span style="color:var(--text-secondary);font-size:12px">ğŸ”¬ èªæ„æœå°‹ä¸­â€¦</span>';
      try {
        const params = new URLSearchParams({ query, scenario, top_k: 6 });
        const res = await fetch(`/api/semantic-search?${params}`);
        const data = await res.json();
        const matches = data.matches || [];
        if (!matches.length) {
          resultsEl.innerHTML = '<span style="color:var(--muted);font-size:12px">æ‰¾ä¸åˆ°ç›¸ä¼¼é—œéµå­—</span>';
          return;
        }
        resultsEl.innerHTML = `
          <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">èªæ„ç›¸ä¼¼é—œéµå­—ï¼š</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;">
            ${matches.map(m => `
              <span style="padding:3px 10px;border-radius:99px;background:rgba(139,92,246,0.15);color:#c4b5fd;font-size:12px;border:1px solid rgba(139,92,246,0.25);"
                title="ç›¸ä¼¼åº¦ ${(m.score * 100).toFixed(0)}%">
                ${m.keyword} <span style="opacity:0.6;font-size:10px">${(m.score * 100).toFixed(0)}%</span>
              </span>`).join('')}
          </div>`;
      } catch (e) {
        resultsEl.innerHTML = '<span style="color:var(--rose);font-size:12px">âš ï¸ æœå°‹å¤±æ•—</span>';
      }
    }

    // â”€â”€ HF AI Feature 3: å ´æ™¯åˆ†é¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function classifyKeyword(keyword, badgeEl) {
      badgeEl.textContent = 'åˆ†é¡ä¸­â€¦';
      try {
        const res = await fetch(`/api/scenario-classify?keyword=${encodeURIComponent(keyword)}`);
        const data = await res.json();
        if (data.scenario) {
          const pct = Math.round((data.confidence || 0) * 100);
          const icons = { 'æ—…éŠ': 'âœˆï¸', 'å¥åº·': 'ğŸ’ª', 'ç‰™ç§‘': 'ğŸ¦·', 'ä¿å¥å“': 'ğŸ’Š' };
          badgeEl.textContent = `${icons[data.scenario] || 'ğŸ“Œ'} ${data.scenario} ${pct}%`;
          badgeEl.style.background = 'rgba(16,185,129,0.15)';
          badgeEl.style.color = '#6ee7b7';
        } else {
          badgeEl.textContent = '';
        }
      } catch (e) {
        badgeEl.textContent = '';
      }
    }

    // â”€â”€ HF AI Feature 4: AI å¼·åŒ–æœå‹™æ¨æ¸¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function aiEnhanceKeyword(keyword, scenario, servicesEl) {
      servicesEl.innerHTML = '<span style="font-size:10px;color:var(--muted)">âœ¨ AI æ¨æ¸¬ä¸­â€¦</span>';
      try {
        const params = new URLSearchParams({ keyword, scenario });
        const res = await fetch(`/api/ai-services?${params}`);
        const data = await res.json();
        const svcs = data.services || [];
        if (svcs.length) {
          servicesEl.innerHTML = `<div class="service-tags">${svcs.map((s, i) =>
            `<span class="service-tag${i === 0 ? ' primary' : ''}" style="border-color:rgba(139,92,246,0.4);color:#c4b5fd;background:rgba(139,92,246,0.15);">âœ¨ ${s}</span>`
          ).join('')}</div>`;
        } else {
          servicesEl.innerHTML = '<span style="font-size:10px;color:var(--muted)">ï¼ˆç„¡çµæœï¼‰</span>';
        }
      } catch (e) {
        servicesEl.innerHTML = '';
      }
    }

    // â”€â”€ æœå°‹å®Œæˆå¾Œè‡ªå‹•è§¸ç™¼ AI æ´å¯Ÿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _origSearchBase = search;
    search = async function () {
      await _origSearchBase();
      // å–æœ€æ–°çš„ IOT è³‡æ–™å’Œé—œéµå­—
      const kwList = document.getElementById('kw-input').value
        .split(',').map(k => k.trim()).filter(Boolean).slice(0, 5);
      const geo = document.getElementById('geo-select').value;
      if (kwList.length > 0) {
        // å»¶é²ä¸€é»è®“åœ–è¡¨è³‡æ–™å…ˆè¼‰å…¥
        setTimeout(async () => {
          try {
            const params = new URLSearchParams({
              kw: kwList.join(','), geo,
              timeframe: document.getElementById('time-select').value
            });
            const res = await fetch(`/api/interest-over-time?${params}`);
            const iotData = await res.json();
            loadAiInsight(kwList, iotData, geo);
          } catch (e) { /* éœé»˜å¤±æ•— */ }
        }, 500);
      }
    };

    // â”€â”€ æ·±åº¦åˆ†æï¼šToggle å±•é–‹/æ”¶åˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _deepLoaded = new Set();
    function toggleDeepAnalysis(safeId, keyword, scenario) {
      const panel = document.getElementById(`deep-${safeId}`);
      if (!panel) return;
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        if (!_deepLoaded.has(safeId)) {
          _deepLoaded.add(safeId);
          loadKeywordDeepAnalysis(safeId, keyword, scenario);
        }
      } else {
        panel.style.display = 'none';
      }
    }

    async function loadKeywordDeepAnalysis(safeId, keyword, scenario) {
      const panel = document.getElementById(`deep-${safeId}`);
      panel.innerHTML = `
        <div style="color:var(--muted);font-size:12px;padding:8px 0;">â³ AI æ·±åº¦åˆ†æä¸­ï¼ˆæ–°è + å•†æ¥­æ„åœ– + å¹³å°æ­¸å› ï¼‰â€¦</div>`;

      // ä¸¦è¡Œå‘¼å« 3 å€‹ API
      const params = new URLSearchParams({ keyword, scenario });
      const [newsRes, intentRes, platformRes] = await Promise.allSettled([
        fetch(`/api/keyword-news?${params}&max=4`).then(r => r.json()),
        fetch(`/api/commercial-intent?${params}`).then(r => r.json()),
        fetch(`/api/platform-attribution?${params}`).then(r => r.json()),
      ]);

      const newsList = newsRes.status === 'fulfilled' ? (newsRes.value.news || []) : [];
      const intentData = intentRes.status === 'fulfilled' ? intentRes.value : {};
      const platformData = platformRes.status === 'fulfilled' ? platformRes.value : {};

      panel.innerHTML = `
        ${renderNewsPanel(newsList)}
        ${renderIntentPanel(intentData)}
        ${renderPlatformPanel(platformData)}`;
    }

    function renderNewsPanel(news) {
      if (!news.length) return `<div style="font-size:11px;color:var(--muted);margin-bottom:10px;">ğŸ“° æš«ç„¡ç›¸é—œæ–°è</div>`;
      return `
        <div style="margin-bottom:12px;">
          <div style="font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">ğŸ“° æœ€æ–°ç›¸é—œæ–°è</div>
          ${news.map(n => `
            <a href="${n.url}" target="_blank" rel="noopener" style="display:block;padding:6px 8px;margin-bottom:4px;background:rgba(255,255,255,0.04);border-radius:8px;text-decoration:none;border-left:2px solid rgba(139,92,246,0.4);">
              <div style="font-size:12px;color:var(--text);line-height:1.4;">${n.title}</div>
              <div style="font-size:10px;color:var(--muted);margin-top:2px;">${n.source || ''}${n.published_at ? ' Â· ' + n.published_at.slice(0, 10) : ''}</div>
            </a>`).join('')}
        </div>`;
    }

    function renderIntentPanel(data) {
      if (!data.score && data.score !== 0) return '';
      const score = data.score || 0;
      const urgencyColor = { é«˜: '#f87171', ä¸­: '#fbbf24', ä½: '#6ee7b7' }[data.urgency] || '#c4b5fd';
      const typeIcon = { äº¤æ˜“å‹: 'ğŸ›’', è³‡è¨Šå‹: 'ğŸ“–', å°èˆªå‹: 'ğŸ§­' }[data.keyword_type] || 'ğŸ’¡';
      return `
        <div style="margin-bottom:12px;padding:10px;background:rgba(251,191,36,0.06);border-radius:10px;border:1px solid rgba(251,191,36,0.15);">
          <div style="font-size:11px;font-weight:600;color:#fbbf24;margin-bottom:8px;">ğŸ’° å•†æ¥­æ„åœ–è©•åˆ†</div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
            <div style="flex:1;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;">
              <div style="width:${score * 10}%;height:100%;background:linear-gradient(90deg,#fbbf24,#f87171);border-radius:3px;"></div>
            </div>
            <span style="font-size:14px;font-weight:700;color:#fbbf24;">${score.toFixed(1)}</span>
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;font-size:11px;">
            ${data.keyword_type ? `<span style="background:rgba(255,255,255,0.08);padding:2px 8px;border-radius:99px;">${typeIcon} ${data.keyword_type}</span>` : ''}
            ${data.urgency ? `<span style="color:${urgencyColor};background:rgba(255,255,255,0.06);padding:2px 8px;border-radius:99px;">âš¡ æ€¥è¿«æ€§ï¼š${data.urgency}</span>` : ''}
            ${data.price_range ? `<span style="color:var(--text-secondary);padding:2px 8px;">ğŸ’µ ${data.price_range}</span>` : ''}
          </div>
          ${data.motivation ? `<div style="font-size:11px;color:var(--text-secondary);margin-top:6px;">ğŸ“Œ ${data.motivation}</div>` : ''}
        </div>`;
    }

    function renderPlatformPanel(data) {
      const platforms = data.platforms || [];
      if (!platforms.length) return '';
      const icons = {
        'Googleæœå°‹': 'ğŸ”', 'å®˜ç¶²': 'ğŸŒ', 'Instagram': 'ğŸ“¸',
        'Facebook': 'ğŸ‘¥', 'TikTok': 'ğŸµ', 'YouTube': 'â–¶ï¸'
      };
      return `
        <div style="margin-bottom:4px;">
          <div style="font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;">ğŸ“± å¹³å°æ›å…‰æ­¸å› </div>
          ${platforms.slice(0, 6).map(p => `
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
              <span style="font-size:11px;width:80px;color:var(--text-secondary);flex-shrink:0;">${icons[p.name] || 'ğŸ“Œ'} ${p.name}</span>
              <div style="flex:1;height:4px;background:rgba(255,255,255,0.08);border-radius:2px;overflow:hidden;">
                <div style="width:${p.score * 10}%;height:100%;background:linear-gradient(90deg,#8b5cf6,#06b6d4);border-radius:2px;"></div>
              </div>
              <span style="font-size:10px;color:var(--muted);width:24px;text-align:right;">${p.score}</span>
            </div>`).join('')}
          ${data.top_platform ? `<div style="font-size:10px;color:var(--muted);margin-top:4px;">ğŸ† æœ€ä¸»è¦ç®¡é“ï¼š<strong style="color:var(--text-secondary)">${data.top_platform}</strong></div>` : ''}
        </div>`;
    }
  </script>
</body>

</html>